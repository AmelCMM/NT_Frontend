<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NT Chat - End-to-End Encrypted</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    />
    <link rel="stylesheet" href="./chatView.css" />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <div id="sidebar">
      <div class="sidebar-header">
        <h3>NT Secure Chats</h3>
      </div>
      <div class="sidebar-controls">
        <div class="input-group">
          <input
            type="text"
            id="newUser"
            placeholder="Enter username to chat with"
          />
        </div>
        <button onclick="addToChat()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="margin-right: 6px"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Contact
        </button>
      </div>
      <div id="user-list"></div>
    </div>

    <div id="chat-area">
      <div id="chat-header"><h3>Select a contact to start chatting</h3></div>
      <div id="chat-box"></div>
      <form id="chat-form">
        <input
          type="text"
          id="message"
          placeholder="Type your secure message..."
          autocomplete="off"
        />
        <button type="submit">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="margin-right: 6px"
          >
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
          Send
        </button>
      </form>
    </div>

    <script>
      // Fetch session
      const username = sessionStorage.getItem("ntchat_user");
      const token = sessionStorage.getItem("ntchat_token");
      if (!username || !token) {
        alert("Please login to continue");
        window.location.href = "login.html";
      }

      // Socket with auth
      const socket = io("http://localhost:3000", {
        path: "/nt_backends_api/v1/socket.io",
        transports: ["websocket"],
        auth: { token },
      });

      let myPriv, myPub;
      const sharedKeys = {};
      const chatUsers = new Set();
      let activeChat = null;

      const userListDiv = document.getElementById("user-list");
      const chatHeader = document.getElementById("chat-header");
      const chatBox = document.getElementById("chat-box");
      const chatForm = document.getElementById("chat-form");
      const msgInput = document.getElementById("message");

      socket.on("connect", async () => {
        chatHeader.innerHTML = `<h3>Welcome, ${
          JSON.parse(username).username
        }</h3>`;

        // Generate ECDH keys
        const keys = await window.crypto.subtle.generateKey(
          { name: "ECDH", namedCurve: "P-256" },
          true,
          ["deriveKey"]
        );
        myPriv = keys.privateKey;
        myPub = keys.publicKey;
        const raw = await window.crypto.subtle.exportKey("raw", myPub);
        const pubB64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
        socket.emit("register", { username, publicKey: pubB64 });
      });

      function addToChat() {
        const user = document.getElementById("newUser").value.trim();
        if (user && user !== username && !chatUsers.has(user)) {
          chatUsers.add(user);
          const div = document.createElement("div");
          div.className = "chat-user";

          // Create avatar with first letter
          const avatar = document.createElement("div");
          avatar.className = "user-avatar";
          avatar.textContent = user.charAt(0).toUpperCase();

          // Create username span
          const nameSpan = document.createElement("span");
          nameSpan.textContent = user;

          div.appendChild(avatar);
          div.appendChild(nameSpan);
          div.onclick = () => selectChat(user, div);
          userListDiv.appendChild(div);
          document.getElementById("newUser").value = "";
        }
      }

      function selectChat(user, el) {
        activeChat = user;
        chatHeader.innerHTML = `<h3>Chatting with ${user}</h3>`;
        chatBox.innerHTML = "";
        document
          .querySelectorAll(".chat-user")
          .forEach((e) => e.classList.remove("active"));
        el.classList.add("active");
        socket.emit("load_history", { withUser: user });
      }

      socket.on("chat_history", ({ history }) => {
        chatBox.innerHTML = "";
        history.forEach((record) =>
          decryptAndDisplay(record.sender, record.encrypted)
        );
      });

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const txt = msgInput.value.trim();
        if (!txt || !activeChat) return;

        if (!sharedKeys[activeChat]) await requestKey(activeChat);

        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const ct = await window.crypto.subtle.encrypt(
          { name: "AES-GCM", iv },
          sharedKeys[activeChat],
          new TextEncoder().encode(txt)
        );

        const payload = {
          iv: btoa(String.fromCharCode(...iv)),
          data: btoa(String.fromCharCode(...new Uint8Array(ct))),
        };

        socket.emit("private_message", {
          to: activeChat,
          from: username,
          encrypted: payload,
        });

        displayMessage(username, txt);
        msgInput.value = "";
      });

      socket.on("receive_private", async ({ from, encrypted }) => {
        if (!sharedKeys[from]) await requestKey(from);
        decryptAndDisplay(from, encrypted);
      });

      async function requestKey(peer) {
        return new Promise((resolve) => {
          socket.emit("request_public_key", peer);
          socket.once("public_key_response", async ({ publicKey }) => {
            const buf = Uint8Array.from(atob(publicKey), (c) =>
              c.charCodeAt(0)
            );
            const pubKey = await window.crypto.subtle.importKey(
              "raw",
              buf,
              { name: "ECDH", namedCurve: "P-256" },
              true,
              []
            );
            sharedKeys[peer] = await window.crypto.subtle.deriveKey(
              { name: "ECDH", public: pubKey },
              myPriv,
              { name: "AES-GCM", length: 256 },
              false,
              ["encrypt", "decrypt"]
            );
            resolve();
          });
        });
      }

      async function decryptAndDisplay(sender, encrypted) {
        const iv = Uint8Array.from(atob(encrypted.iv), (c) => c.charCodeAt(0));
        const data = Uint8Array.from(atob(encrypted.data), (c) =>
          c.charCodeAt(0)
        );
        const pt = await window.crypto.subtle.decrypt(
          { name: "AES-GCM", iv },
          sharedKeys[sender],
          data
        );
        const msg = new TextDecoder().decode(pt);
        displayMessage(sender, msg);
      }

      function displayMessage(sender, message) {
        const div = document.createElement("div");
        div.className =
          "message " + (sender === username ? "my-message" : "their-message");

        const usernameDiv = document.createElement("div");
        usernameDiv.className = "message-username";
        usernameDiv.textContent = sender === username ? "You" : sender;

        const messageDiv = document.createElement("div");
        messageDiv.textContent = message;

        div.appendChild(usernameDiv);
        div.appendChild(messageDiv);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    </script>
  </body>
</html>
