<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NT Chimuka* Log In</title>
    <link rel="stylesheet" href="./index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
  </head>
  <body>
    <div class="overlay"></div>
    <div class="login-container" aria-hidden="true">
      <h1>NT Chat</h1>
      <p class="subtitle">End To End Encrypted Chat Platform</p>
      <form id="login-form">
        <div class="input-group">
          <label for="username">Username</label>
          <div class="input-wrapper">
            <i class="fas fa-user"></i>
            <input
              type="text"
              id="username"
              placeholder="Enter your username"
              required
            />
          </div>
        </div>

        <div class="input-group">
          <label for="password">Password</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input
              type="password"
              id="password"
              placeholder="Enter your password"
              required
            />
          </div>
        </div>

        <button type="submit" class="login-btn">
          <span>Log In</span>
          <i class="fas fa-arrow-right"></i>
        </button>
      </form>

      <p class="link-text">
        New to NT Chat? <a href="./createAccount.html">Create Account</a>
      </p>

      <div class="info-box">
        <p>Chats only last as long as you're active or until one user logs out.</p>
        <p>Password reset isn't supported as we don't use real-world credentials.</p>
        <p>No data is collected. We follow a No-Log Policy, respecting your privacy. This platform is free to use... Enjoy! ðŸ˜Š</p>
      </div>

      <div class="error-message" id="error-message" style="display: none"></div>
    </div>

    <script>
      async function handleLogin(event) {
        event.preventDefault();

        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const errorMessageDiv = document.getElementById("error-message");

        errorMessageDiv.style.display = "none";
        errorMessageDiv.textContent = "";

        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
          errorMessageDiv.textContent = "Please enter both username and password.";
          errorMessageDiv.style.display = "block";
          return;
        }

        const sanitizedUsername = username.replace(/[<>"'();]/g, "");
        const sanitizedPassword = password.replace(/[<>"'();]/g, "");

        const loginData = {
          username: sanitizedUsername,
          password: sanitizedPassword,
        };

        try {
          const response = await fetch("https://nt-secure-chat-backend-api.onrender.com/nt_backends_api/v1/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(loginData),
          });

          if (!response.ok) {
            throw new Error("Login failed. Please check your credentials.");
          }

          const result = await response.json();
          console.table(result);

          if (result.token && result.user) {
            sessionStorage.setItem("ntchat_token", result.token); // Secure token
            sessionStorage.setItem("ntchat_user", JSON.stringify(result.user)); // Secure user info
            window.location.href = "./chatView.html"; // Go to chat view
          } else {
            throw new Error(result.message || "Authentication failed.");
          }
        } catch (error) {
          errorMessageDiv.textContent = error.message;
          errorMessageDiv.style.display = "block";
        }
      }

      document.getElementById("login-form").addEventListener("submit", handleLogin);

      // Optional protections
      document.body.style.userSelect = "none";
      document.body.style.webkitUserSelect = "none";
      document.body.style.MozUserSelect = "none";
      document.body.style.msUserSelect = "none";

      document.querySelectorAll("input").forEach((input) => {
        input.style.userSelect = "auto";
        input.style.webkitUserSelect = "auto";
        input.style.MozUserSelect = "auto";
        input.style.msUserSelect = "auto";
      });

      document.querySelectorAll("a").forEach((link) => {
        link.addEventListener("dragstart", (e) => e.preventDefault());
        link.addEventListener("contextmenu", (e) => e.preventDefault());

        let touchTimer;
        link.addEventListener("touchstart", (e) => {
          touchTimer = setTimeout(() => e.preventDefault(), 500);
        });
        link.addEventListener("touchend", () => clearTimeout(touchTimer));
        link.addEventListener("touchmove", () => clearTimeout(touchTimer));
      });

      document.addEventListener("drag", (e) => e.preventDefault());
    </script>
  </body>
</html>
